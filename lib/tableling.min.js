/*!
 * Tableling v0.1.1
 * Copyright (c) 2012-2014 Simon Oulevay (Alpha Hydrae) <hydrae.alpha@gmail.com>
 * Distributed under MIT license
 * https://github.com/AlphaHydrae/tableling
 */
Backbone.Tableling=Tableling=function(a,b,c){var d={version:"0.1.1"};return d.Table=a.Marionette.LayoutView.extend({className:"tableling",config:{page:1},initialize:function(c){if(c=c||{},!this.getCollection(this.getResource()))throw new Error("Missing collection; pass it to the constructor or override #getCollection");this.config=b.extend(b.clone(this.config||{}),b.result(c,"config")||{}),this.vent=c.vent||new a.Wreqr.EventAggregator,this.fetchOptions=b.extend(b.clone(this.fetchOptions||{}),b.result(c,"fetchOptions")||{}),"undefined"!=typeof c.autoUpdate&&(this.autoUpdate=c.autoUpdate),"undefined"==typeof this.autoUpdate&&(this.autoUpdate=!0),this.vent.on("table:update",this.onUpdate,this),this.once("render",this.setup,this),"function"==typeof this.initializeTable&&this.initializeTable(c)},setup:function(){this.ventTrigger("table:setup",this.config),this.autoUpdate&&this.ventTrigger("table:update")},getResource:function(){return this.collection||this.model},getCollection:function(){return this.collection},update:function(a,b){this.ventTrigger("table:update",a,b)},onUpdate:function(a,c){b.each(a||{},b.bind(this.updateValue,this)),(!c||"undefined"==typeof c.refresh||c.refresh)&&this.refresh()},updateValue:function(a,b){a&&a.toString().length?this.config[b]=a:delete this.config[b]},refresh:function(){var a=b.clone(this.fetchOptions);a.data=this.requestData(),a.success=b.bind(this.processResponse,this),a.reset=!0,this.ventTrigger("table:refreshing",a.data),this.getResource().fetch(a)},requestData:function(){return this.config},processResponse:function(a,b){this.config.length=this.getCollection(a).length,this.config.total=b.total,b.page&&(this.config.page=b.page),this.ventTrigger("table:refreshed",this.config)},ventTrigger:function(){var a=Array.prototype.slice.call(arguments);d.debug&&console.log(b.first(a)+" - "+JSON.stringify(a.slice(1))),this.vent.trigger.apply(this.vent,a)}}),d.Collection=a.Collection.extend({parse:function(a){return a.data}}),d.Modular=d.Table.extend({modules:[],setup:function(){this.moduleViews={},b.each(this.modules,this.setupModule,this),d.Table.prototype.setup.call(this)},setupModule:function(a){var c=a+"Region",d=this[a+"View"],e=b.extend(this.getModuleOptions(a),{vent:this.vent});b.defaults(e,{collection:this.getCollection(this.getResource())});var f=new d(e);return this.moduleViews[a]=f,this[c].show(f),f},getCollection:function(){return this.collection||(this.moduleViews&&this.moduleViews.table?this.moduleViews.table.collection:void 0)},getModuleOptions:function(a){return b.result(this,a+"ViewOptions")||{}}}),d.Module=a.Marionette.ItemView.extend({i18n:{},templateHelpers:function(){return this.i18n},initialize:function(a){this.vent=a.vent,this.vent.on("table:setup",this.setup,this),this.vent.on("table:refreshed",this.refresh,this),this.i18n=b.clone(a.i18n||this.i18n),"function"==typeof this.initializeModule&&this.initializeModule(a)},update:function(){this.vent.trigger("table:update",this.config())},setup:function(){},refresh:function(){},config:function(){return{}}}),d.FieldModule=d.Module.extend({initialize:function(a){if(!b.isString(this.name))throw new Error("Tableling module must have a name property.");this.ui||(this.ui={}),this.ui.field='[name="'+this.name+'"]',this.events||(this.events={}),this.events.submit="onSubmit",this.events['change [name="'+this.name+'"]']="update",d.Module.prototype.initialize.call(this,a)},setup:function(a){this.setupValue(a[this.name]),this.vent.trigger("table:update",this.config(),{refresh:!1})},setupValue:function(a){this.ui.field.val(a)},config:function(){var a={};return a[this.name]=this.ui.field.val(),a},onSubmit:function(a){return a.preventDefault(),!1}}),d.Plain={},d.Plain.Table=d.Modular.extend({className:"tableling",modules:["table","pageSize","quickSearch","info","page"],template:b.template('<div class="header"><div class="pageSize" /><div class="quickSearch" /></div><div class="table" /><div class="footer"><div class="info" /><div class="page" /></div>'),regions:{tableRegion:".table",pageSizeRegion:".pageSize",quickSearchRegion:".quickSearch",infoRegion:".info",pageRegion:".page"}}),d.Plain.TableView=a.Marionette.CompositeView.extend({moduleEvents:{"click thead th.sorting":"updateSort","click thead th.sorting-asc":"updateSort","click thead th.sorting-desc":"updateSort"},initialize:function(a){this.vent=a.vent,this.sort=[],this.vent.on("table:setup",this.setSort,this),this.vent.on("table:refreshed",this.setSort,this),this.events=b.extend({},this.events||{},this.moduleEvents),"function"==typeof this.initializeModule&&this.initializeModule(a)},updateSort:function(a){var d=c(a.currentTarget);if(d.hasClass("sorting")||d.hasClass("sorting-asc")||d.hasClass("sorting-desc")){var e=this.fieldName(d);if(a.shiftKey||1==this.sort.length){var f=-1;if(b.find(this.sort,function(a,b){a.split(" ")[0]==e&&(f=b)}),f>=0){var g=this.sort[f].split(" ");return this.sort[f]=g[0]+" "+("asc"==g[1]?"desc":"asc"),this.showSort(),this.vent.trigger("table:update",this.config())}}a.shiftKey||(this.sort.length=0),this.sort.push(e+" asc"),this.showSort(),this.vent.trigger("table:update",this.config())}},setSort:function(a){a&&a.sort&&(this.sort=a.sort.slice(0),this.showSort())},showSort:function(){this.$el.find("thead th.sorting, thead th.sorting-asc, thead th.sorting-desc").removeClass("sorting sorting-asc sorting-desc").addClass("sorting");for(var a=0;a<this.sort.length;a++){var b=this.sort[a].split(" "),c=b[0],d=b[1];field=this.$el.find('thead [data-field="'+c+'"]'),field.length||(field=this.$el.find('thead th:contains("'+c+'")')),field.length&&field.removeClass("sorting").addClass("desc"==d?"sorting-desc":"sorting-asc")}},config:function(){return{page:1,sort:this.sortConfig()}},sortConfig:function(){return this.sort.length?this.sort:null},fieldName:function(a){return a.data("field")||a.text()}}),d.Plain.PageSizeView=d.Plain.Table.prototype.pageSizeView=d.FieldModule.extend({name:"pageSize",template:function(a){return b.template('<select name="pageSize" /> <%- entries %>')(a)},i18n:{entries:"entries per page"},sizes:[10,15,20,25,50],ui:{field:"select"},initialize:function(a){this.sizes=b.clone(a.sizes||this.sizes),d.FieldModule.prototype.initialize.call(this,a)},onRender:function(){this.ui.field.empty(),b.each(this.sizes,b.bind(this.addSize,this))},addSize:function(a){c("<option />").text(a).appendTo(this.ui.field)},setupValue:function(a){a&&d.FieldModule.prototype.setupValue.apply(this,Array.prototype.slice.call(arguments))},config:function(){var a=d.FieldModule.prototype.config.call(this);return a.page=1,a}}),d.Plain.QuickSearchView=d.Plain.Table.prototype.quickSearchView=d.FieldModule.extend({name:"quickSearch",template:function(a){return b.template('<input type="text" name="quickSearch" placeholder="<%- quickSearch %>" />')(a)},i18n:{quickSearch:"Quick search..."},config:function(){var a=d.FieldModule.prototype.config.call(this);return a.page=1,a}}),d.Plain.InfoView=d.Plain.Table.prototype.infoView=d.Module.extend({template:function(a){return b.template(a.template)({first:'<span class="first">0</span>',last:'<span class="last">0</span>',total:'<span class="total">0</span>'})},i18n:{template:"Showing <%= first %> to <%= last %> of <%= total %> entries"},ui:{first:".first",last:".last",total:".total"},refresh:function(a){a&&(this.ui.first.text(this.firstRecord(a)),this.ui.last.text(this.lastRecord(a)),this.ui.total.text(a.total))},firstRecord:function(a){return a.length?((a.page||1)-1)*a.pageSize+1:0},lastRecord:function(a){return a.length?this.firstRecord(a)+a.length-1:0}}),d.Plain.PageView=d.Plain.Table.prototype.pageView=d.Module.extend({template:b.template('<ul class="pagination"><li class="first"><a href="#">&lt;&lt;</a></li><li class="previous"><a href="#">&lt;</a></li><li class="next"><a href="#">&gt;</a></li><li class="last"><a href="#">&gt;&gt;</a></li></ul>'),pageTemplate:b.template('<li class="page"><a href="#"><%- number %></a></li>'),ui:{first:".first",previous:".previous",next:".next",last:".last"},events:{"click .first:not(.disabled)":"goToFirstPage","click .previous:not(.disabled)":"goToPreviousPage","click .page:not(.disabled)":"goToPage","click .next:not(.disabled)":"goToNextPage","click .last:not(.disabled)":"goToLastPage"},refresh:function(a){this.$el.find(".page").remove(),a&&a.length?(this.data=a,this.enable(this.ui.first,this.getPage(a)>1),this.enable(this.ui.previous,this.getPage(a)>1),this.setupPages(),this.enable(this.ui.next,this.getPage(a)<this.numberOfPages(a)),this.enable(this.ui.last,this.getPage(a)<this.numberOfPages(a))):(this.ui.first.addClass("disabled"),this.ui.previous.addClass("disabled"),this.ui.next.addClass("disabled"),this.ui.last.addClass("disabled"))},setupPages:function(){var a=this.getPage(this.data),d=this.numberOfPages(),e=a-2;4>d-e&&(e=d-4),1>e&&(e=1);var f=5;e+f-1>d&&(f=d-e+1),b.times(f,function(a){c(this.pageTemplate({number:e+a})).insertBefore(this.ui.next)},this);var g=a-e;this.$el.find(".page").slice(g,g+1).addClass("disabled")},enable:function(a,b){a.removeClass("disabled"),b||a.addClass("disabled")},numberOfPages:function(){return Math.ceil(this.data.total/this.data.pageSize)},goToFirstPage:function(a){a.preventDefault(),this.goToPageNumber(1)},goToPreviousPage:function(a){a.preventDefault(),this.goToPageNumber(this.getPage(this.data)-1)},goToPage:function(a){a.preventDefault(),this.goToPageNumber(parseInt(c(a.target).text(),10))},goToNextPage:function(a){a.preventDefault(),this.goToPageNumber(this.getPage(this.data)+1)},goToLastPage:function(a){a.preventDefault(),this.goToPageNumber(this.numberOfPages())},goToPageNumber:function(a){this.vent.trigger("table:update",{page:a})},getPage:function(a){return a.page||1}}),d.Bootstrap={},d.Bootstrap.Table=d.Plain.Table.extend({template:b.template('<div class="header clearfix"><div class="pageSize pull-left" /><div class="quickSearch pull-right" /></div><div class="table" /><div class="footer clearfix"><div class="info pull-left" /><div class="page pull-right" /></div>')}),d.Bootstrap.TableView=d.Plain.TableView.extend({}),d.Bootstrap.PageSizeView=d.Bootstrap.Table.prototype.pageSizeView=d.Plain.PageSizeView.extend({tagName:"form",className:"form-inline",attributes:{role:"form"},template:function(a){return b.template('<div class="formGroup"><select name="pageSize" class="form-control"><option>5</option><option>10</option><option>15</option></select> <%- entries %></div>')(a)}}),d.Bootstrap.QuickSearchView=d.Bootstrap.Table.prototype.quickSearchView=d.Plain.QuickSearchView.extend({tagName:"form",className:"form-inline",attributes:{role:"form"},template:function(a){return b.template('<div class="formGroup"><input type="text" name="quickSearch" class="form-control" placeholder="<%- quickSearch %>" /></div>')(a)}}),d.Bootstrap.InfoView=d.Bootstrap.Table.prototype.infoView=d.Plain.InfoView.extend({}),d.Bootstrap.PageView=d.Bootstrap.Table.prototype.pageView=d.Plain.PageView.extend({}),d}(Backbone,_,$||window.jQuery||window.Zepto||window.ender);