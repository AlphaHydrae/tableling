/*!
 * Tableling v0.0.4
 * Copyright (c) 2012 Simon Oulevay (Alpha Hydrae)
 * Distributed under MIT license
 * https://github.com/AlphaHydrae/tableling
 */(function(a){a.Tableling=Tableling=Backbone.Marionette.Layout.extend({className:"tableling",tableling:{page:1,pageSize:15},initialize:function(a){a=a||{},this.tableling=_.extend(_.clone(this.tableling),a.tableling||{}),this.vent=a.vent||new Backbone.Marionette.EventAggregator,this.vent.on("tableling:update",this.update,this),this.on("render",this.setup,this)},setup:function(){this.vent.trigger("tableling:update")},getCollection:function(){throw new Error("#getCollection not implemented. It should return the Backbone.Collection instance used to fetch data.")},update:function(a,b){_.each(this.filterConfig(a||{}),_.bind(this.updateValue,this)),(!b||typeof b.refresh=="undefined"||b.refresh)&&this.refresh()},updateValue:function(a,b){a&&a.toString().length?this.tableling[b]=a:delete this.tableling[b]},refresh:function(){var a=this.requestData();this.ventTrigger("tableling:refreshing",a),this.getCollection().fetch(_.extend(this.tableling.request||{},{data:a,success:_.bind(this.processResponse,this)}))},processResponse:function(a,b){this.tableling.length=a.length,this.tableling.total=b.total,this.ventTrigger("tableling:refreshed",this.filterConfig(this.tableling,!0))},requestData:function(){return this.filterConfig(this.tableling)},filterConfig:function(a,b){return b?_.pick(a,"page","pageSize","quickSearch","sort","length","total"):_.pick(a,"page","pageSize","quickSearch","sort")},ventTrigger:function(){var a=Array.prototype.slice.call(arguments);this.vent.trigger.apply(this.vent,a),Tableling.debug&&console.log(a.shift()+" - "+JSON.stringify(a))}}),Tableling.Collection=Backbone.Collection.extend({parse:function(a){return a.data}}),Tableling.Modular=Tableling.extend({modules:[],setup:function(){this.moduleViews={},_.each(this.modules,_.bind(this.setupModule,this)),Tableling.prototype.setup.call(this)},setupModule:function(a){var b=a+"Region",c=this[a+"View"],d=_.extend(this[a+"ViewOptions"]||{},{vent:this.vent}),e=new c(d);return this.moduleViews[a]=e,this[b].show(e),e},getCollection:function(){return this.moduleViews.table.collection}}),_.extend(Tableling.Modular,{createModule:function(a){return Backbone.Marionette.ItemView.extend(_.extend({initialize:function(a){this.vent=a.vent,this.vent.on("tableling:refreshed",this.refresh,this),this.on("render",this.refresh,this)},update:function(){this.vent.trigger("tableling:update",this.config())},refresh:function(a){},config:function(){return{}}},a))},createFieldModule:function(a,b){var c={ui:{field:'[name="'+a+'"]'},events:{},config:function(){var b={};return b[a]=this.ui.field.val(),b}};return c.events['change [name="'+a+'"]']="update",Tableling.Modular.createModule(_.extend(c,b))}})})(this);