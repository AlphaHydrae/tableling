/*!
 * Tableling v0.0.7
 * Copyright (c) 2012 Simon Oulevay (Alpha Hydrae) <hydrae.alpha@gmail.com>
 * Distributed under MIT license
 * https://github.com/AlphaHydrae/tableling
 */
Backbone.Tableling=Tableling=function(e,t,n){var r={version:"0.0.7"};return r.Table=e.Marionette.Layout.extend({className:"tableling",tableling:{page:1,pageSize:15},initialize:function(n){n=n||{},this.tableling=t.extend(t.clone(this.tableling),this.filterConfig(n)),this.vent=n.vent||new e.Marionette.EventAggregator,this.vent.on("table:update",this.update,this),this.on("render",this.setup,this)},setup:function(){this.vent.trigger("table:setup",this.filterConfig(this.tableling,!0)),this.vent.trigger("table:update")},getCollection:function(){throw new Error("#getCollection not implemented. It should return the Backbone.Collection instance used to fetch data.")},update:function(e,n){t.each(this.filterConfig(e||{}),t.bind(this.updateValue,this)),(!n||typeof n.refresh=="undefined"||n.refresh)&&this.refresh()},updateValue:function(e,t){e&&e.toString().length?this.tableling[t]=e:delete this.tableling[t]},refresh:function(){var e=this.requestData();this.ventTrigger("table:refreshing",e),this.getCollection().fetch(t.extend(this.tableling.request||{},{data:e,success:t.bind(this.processResponse,this)}))},requestData:function(){return t.extend(t.clone(this.fetchOptions||{}),this.filterConfig(this.tableling))},processResponse:function(e,t){this.tableling.length=e.length,this.tableling.total=t.total,this.ventTrigger("table:refreshed",this.filterConfig(this.tableling,!0))},filterConfig:function(e,n){return n?t.pick(e,"page","pageSize","quickSearch","sort","length","total"):t.pick(e,"page","pageSize","quickSearch","sort")},ventTrigger:function(){var e=Array.prototype.slice.call(arguments);this.vent.trigger.apply(this.vent,e),r.debug&&console.log(e.shift()+" - "+JSON.stringify(e))}}),r.Collection=e.Collection.extend({parse:function(e){return e.data}}),r.Modular=r.Table.extend({modules:[],setup:function(){this.moduleViews={},t.each(this.modules,t.bind(this.setupModule,this)),r.Table.prototype.setup.call(this)},setupModule:function(e){var n=e+"Region",r=this[e+"View"],i=t.extend(this[e+"ViewOptions"]||{},{vent:this.vent}),s=new r(i);return this.moduleViews[e]=s,this[n].show(s),s},getCollection:function(){return this.moduleViews.table.collection}}),t.extend(r.Modular,{createModule:function(n){return e.Marionette.ItemView.extend(t.extend({initialize:function(e){this.vent=e.vent,this.vent.on("table:refreshed",this.refresh,this),this.on("render",this.refresh,this)},update:function(){this.vent.trigger("table:update",this.config())},refresh:function(e){},config:function(){return{}}},n))},createFieldModule:function(e,n){var i={ui:{field:'[name="'+e+'"]'},events:{},config:function(){var t={};return t[e]=this.ui.field.val(),t}};return i.events['change [name="'+e+'"]']="update",r.Modular.createModule(t.extend(i,n))}}),r.Bootstrap={},r.Bootstrap.Table=r.Modular.extend({className:"tableling",modules:["table","pageSize","quickSearch","info","pagination"],template:t.template('<div class="tableling-headers"><div class="tableling-page-size pull-left" /><div class="tableling-quick-search pull-right" /></div><div class="tableling-table" /><div class="tableling-footers"><div class="tableling-info pull-left" /><div class="tableling-pagination pull-right" /></div>'),regions:{tableRegion:".tableling-table",pageSizeRegion:".tableling-page-size",quickSearchRegion:".tableling-quick-search",infoRegion:".tableling-info",paginationRegion:".tableling-pagination"}}),t.extend(r.Bootstrap,{TableView:e.Marionette.CompositeView.extend({events:{"click thead th":"updateSort"},initialize:function(e){this.vent=e.vent,this.sort=[]},updateSort:function(e){var r=n(e.currentTarget);if(!(r.hasClass("sorting")||r.hasClass("sorting-asc")||r.hasClass("sorting-desc")))return;var i=this.fieldName(r);if(e.shiftKey||this.sort.length==1){var s=t.find(this.sort,function(e){return e.field==i});if(s)return s.direction=s.direction=="asc"?"desc":"asc",r.removeClass("sorting sorting-asc sorting-desc"),r.addClass("sorting-"+s.direction),this.vent.trigger("table:update",this.config())}e.shiftKey||(this.sort.length=0,this.$el.find("thead th").removeClass("sorting sorting-asc sorting-desc").addClass("sorting")),this.sort.push({field:i,direction:"asc"}),r.removeClass("sorting sorting-asc sorting-desc").addClass("sorting-asc"),this.vent.trigger("table:update",this.config())},config:function(){return{page:1,sort:this.sortConfig()}},sortConfig:function(){return this.sort.length?t.map(this.sort,function(e){return e.field+" "+e.direction}):null},fieldName:function(e){return e.data("field")||e.text().toLowerCase()}})}),t.extend(r.Bootstrap,{PageSizeView:r.Modular.createFieldModule("pageSize",{template:t.template('<select name="pageSize" class="input-mini"><option>5</option><option>10</option><option>15</option></select> entries per page')})}),t.extend(r.Bootstrap.Table.prototype,{pageSizeView:r.Bootstrap.PageSizeView}),t.extend(r.Bootstrap,{QuickSearchView:r.Modular.createFieldModule("quickSearch",{template:t.template('<input type="text" name="quickSearch" placeholder="Quick search..." />')})}),t.extend(r.Bootstrap.Table.prototype,{quickSearchView:r.Bootstrap.QuickSearchView}),t.extend(r.Bootstrap,{InfoView:r.Modular.createModule({template:t.template('Showing <span class="first">0</span> to <span class="last">0</span> of <span class="total">0</span> entries'),ui:{first:".first",last:".last",total:".total"},refresh:function(e){e&&(this.ui.first.text(this.firstRecord(e)),this.ui.last.text(this.lastRecord(e)),this.ui.total.text(e.total))},firstRecord:function(e){return e.length?(e.page-1)*e.pageSize+1:0},lastRecord:function(e){return e.length?this.firstRecord(e)+e.length-1:0}})}),t.extend(r.Bootstrap.Table.prototype,{infoView:r.Bootstrap.InfoView}),t.extend(r.Bootstrap,{PaginationView:r.Modular.createModule({template:t.template('<div class="pagination"><ul><li class="first"><a href="#">&lt;&lt;</a></li><li class="previous"><a href="#">&lt;</a></li><li class="next"><a href="#">&gt;</a></li><li class="last"><a href="#">&gt;&gt;</a></li></ul></div>'),ui:{first:".first",previous:".previous",next:".next",last:".last"},events:{"click .first:not(.disabled)":"goToFirstPage","click .previous:not(.disabled)":"goToPreviousPage","click .next:not(.disabled)":"goToNextPage","click .last:not(.disabled)":"goToLastPage"},refresh:function(e){e?(this.data=e,this.enable(this.ui.first,e.page>1),this.enable(this.ui.previous,e.page>1),this.enable(this.ui.next,e.page<this.numberOfPages(e)),this.enable(this.ui.last,e.page<this.numberOfPages(e))):(this.ui.first.addClass("disabled"),this.ui.previous.addClass("disabled"),this.ui.next.addClass("disabled"),this.ui.last.addClass("disabled"))},enable:function(e,t){e.removeClass("disabled"),t||e.addClass("disabled")},numberOfPages:function(){return Math.ceil(this.data.total/this.data.pageSize)},goToFirstPage:function(){this.goToPage(1)},goToPreviousPage:function(){this.goToPage(this.data.page-1)},goToNextPage:function(){this.goToPage(this.data.page+1)},goToLastPage:function(){this.goToPage(this.numberOfPages())},goToPage:function(e){this.vent.trigger("table:update",{page:e})}})}),t.extend(r.Bootstrap.Table.prototype,{paginationView:r.Bootstrap.PaginationView}),r}(Backbone,_,$||window.jQuery||window.Zepto||window.ender);