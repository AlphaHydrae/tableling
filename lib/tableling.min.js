/*!
 * Tableling v0.0.10
 * Copyright (c) 2012-2013 Simon Oulevay (Alpha Hydrae) <hydrae.alpha@gmail.com>
 * Distributed under MIT license
 * https://github.com/AlphaHydrae/tableling
 */
Backbone.Tableling=Tableling=function(e,t,n){var r={version:"0.0.10"};return r.Table=e.Marionette.Layout.extend({className:"tableling",config:{page:1},initialize:function(n){n=n||{},this.config=t.extend(t.clone(this.config||{}),t.result(n,"config")||{}),this.vent=n.vent||new e.Marionette.EventAggregator,this.fetchOptions=t.extend(t.clone(this.fetchOptions||{}),t.result(n,"fetchOptions")||{}),this.vent.on("table:update",this.update,this),this.on("render",this.setup,this)},setup:function(){this.ventTrigger("table:setup",this.config),this.ventTrigger("table:update")},getCollection:function(){throw new Error("#getCollection not implemented. It should return the Backbone.Collection instance used to fetch data.")},update:function(e,n){t.each(e||{},t.bind(this.updateValue,this)),(!n||typeof n.refresh=="undefined"||n.refresh)&&this.refresh()},updateValue:function(e,t){e&&e.toString().length?this.config[t]=e:delete this.config[t]},refresh:function(){var e=t.clone(this.fetchOptions);e.data=this.requestData(),e.success=t.bind(this.processResponse,this),this.ventTrigger("table:refreshing",e.data),this.getCollection().fetch(e)},requestData:function(){return this.config},processResponse:function(e,t){this.config.length=e.length,this.config.total=t.total,this.ventTrigger("table:refreshed",this.config)},ventTrigger:function(){var e=Array.prototype.slice.call(arguments);r.debug&&console.log(t.first(e)+" - "+JSON.stringify(e.slice(1))),this.vent.trigger.apply(this.vent,e)}}),r.Collection=e.Collection.extend({parse:function(e){return e.data}}),r.Modular=r.Table.extend({modules:[],setup:function(){this.moduleViews={},t.each(this.modules,t.bind(this.setupModule,this)),r.Table.prototype.setup.call(this)},setupModule:function(e){var n=e+"Region",r=this[e+"View"],i=t.extend(this[e+"ViewOptions"]||{},{vent:this.vent}),s=new r(i);return this.moduleViews[e]=s,this[n].show(s),s},getCollection:function(){return this.moduleViews.table.collection}}),r.Module=e.Marionette.ItemView.extend({initialize:function(e){this.vent=e.vent,this.vent.on("table:setup",this.setup,this),this.vent.on("table:refreshed",this.refresh,this)},update:function(){this.vent.trigger("table:update",this.config())},setup:function(e){},refresh:function(e){},config:function(){return{}}}),r.FieldModule=r.Module.extend({initialize:function(e){r.Module.prototype.initialize.call(this,e),this.ui||(this.ui={}),this.ui.field='[name="'+this.name+'"]',this.events||(this.events={}),this.events['change [name="'+this.name+'"]']="update"},setup:function(e){this.ui.field.val(e[this.name]),this.vent.trigger("table:update",this.config(),{refresh:!1})},config:function(){var e={};return e[this.name]=this.ui.field.val(),e}}),r.Plain={},r.Plain.Table=r.Modular.extend({className:"tableling",modules:["table","pageSize","quickSearch","info","pagination"],template:t.template('<div class="header"><div class="pageSize" /><div class="quickSearch" /></div><div class="table" /><div class="footer"><div class="info" /><div class="pagination" /></div>'),regions:{tableRegion:".table",pageSizeRegion:".pageSize",quickSearchRegion:".quickSearch",infoRegion:".info",paginationRegion:".pagination"}}),r.Plain.TableView=e.Marionette.CompositeView.extend({events:{"click thead th":"updateSort"},initialize:function(e){this.vent=e.vent,this.sort=[]},updateSort:function(e){var r=n(e.currentTarget);if(!(r.hasClass("sorting")||r.hasClass("sorting-asc")||r.hasClass("sorting-desc")))return;var i=this.fieldName(r);if(e.shiftKey||this.sort.length==1){var s=t.find(this.sort,function(e){return e.field==i});if(s)return s.direction=s.direction=="asc"?"desc":"asc",r.removeClass("sorting sorting-asc sorting-desc"),r.addClass("sorting-"+s.direction),this.vent.trigger("table:update",this.config())}e.shiftKey||(this.sort.length=0,this.$el.find("thead th").removeClass("sorting sorting-asc sorting-desc").addClass("sorting")),this.sort.push({field:i,direction:"asc"}),r.removeClass("sorting sorting-asc sorting-desc").addClass("sorting-asc"),this.vent.trigger("table:update",this.config())},config:function(){return{page:1,sort:this.sortConfig()}},sortConfig:function(){return this.sort.length?t.map(this.sort,function(e){return e.field+" "+e.direction}):null},fieldName:function(e){return e.data("field")||e.text().toLowerCase()}}),r.Plain.PageSizeView=r.Plain.Table.prototype.pageSizeView=r.FieldModule.extend({name:"pageSize",template:t.template('<select name="pageSize" /> entries per page'),sizes:[10,15,20,25,50],ui:{field:"select"},initialize:function(e){r.FieldModule.prototype.initialize.call(this,e),this.sizes=t.clone(e.sizes||this.sizes)},onRender:function(){this.ui.field.empty(),t.each(this.sizes,t.bind(this.addSize,this))},addSize:function(e){n("<option />").text(e).appendTo(this.ui.field)},config:function(){var e=r.FieldModule.prototype.config.call(this);return e.page=1,e}}),r.Plain.QuickSearchView=r.Plain.Table.prototype.quickSearchView=r.FieldModule.extend({name:"quickSearch",template:t.template('<input type="text" name="quickSearch" placeholder="Quick search..." />'),config:function(){var e=r.FieldModule.prototype.config.call(this);return e.page=1,e}}),r.Plain.InfoView=r.Plain.Table.prototype.infoView=r.Module.extend({template:t.template('Showing <span class="first">0</span> to <span class="last">0</span> of <span class="total">0</span> entries'),ui:{first:".first",last:".last",total:".total"},refresh:function(e){e&&(this.ui.first.text(this.firstRecord(e)),this.ui.last.text(this.lastRecord(e)),this.ui.total.text(e.total))},firstRecord:function(e){return e.length?((e.page||1)-1)*e.pageSize+1:0},lastRecord:function(e){return e.length?this.firstRecord(e)+e.length-1:0}}),r.Plain.PaginationView=r.Plain.Table.prototype.paginationView=r.Module.extend({template:t.template('<div class="pagination"><ul><li class="first"><a href="#">&lt;&lt;</a></li><li class="previous"><a href="#">&lt;</a></li><li class="next"><a href="#">&gt;</a></li><li class="last"><a href="#">&gt;&gt;</a></li></ul></div>'),ui:{first:".first",previous:".previous",next:".next",last:".last"},events:{"click .first:not(.disabled)":"goToFirstPage","click .previous:not(.disabled)":"goToPreviousPage","click .next:not(.disabled)":"goToNextPage","click .last:not(.disabled)":"goToLastPage"},refresh:function(e){e?(this.data=e,this.enable(this.ui.first,this.getPage(e)>1),this.enable(this.ui.previous,this.getPage(e)>1),this.enable(this.ui.next,this.getPage(e)<this.numberOfPages(e)),this.enable(this.ui.last,this.getPage(e)<this.numberOfPages(e))):(this.ui.first.addClass("disabled"),this.ui.previous.addClass("disabled"),this.ui.next.addClass("disabled"),this.ui.last.addClass("disabled"))},enable:function(e,t){e.removeClass("disabled"),t||e.addClass("disabled")},numberOfPages:function(){return Math.ceil(this.data.total/this.data.pageSize)},goToFirstPage:function(){this.goToPage(1)},goToPreviousPage:function(){this.goToPage(this.getPage(this.data)-1)},goToNextPage:function(){this.goToPage(this.getPage(this.data)+1)},goToLastPage:function(){this.goToPage(this.numberOfPages())},goToPage:function(e){this.vent.trigger("table:update",{page:e})},getPage:function(e){return e.page||1}}),r.Bootstrap={},r.Bootstrap.Table=r.Plain.Table.extend({template:t.template('<div class="header"><div class="pageSize pull-left" /><div class="quickSearch pull-right" /></div><div class="table" /><div class="footer"><div class="info pull-left" /><div class="pagination pull-right" /></div>')}),r.Bootstrap.TableView=r.Plain.TableView.extend({}),r.Bootstrap.PageSizeView=r.Bootstrap.Table.prototype.pageSizeView=r.Plain.PageSizeView.extend({template:t.template('<select name="pageSize" class="input-mini"><option>5</option><option>10</option><option>15</option></select> entries per page')}),r.Bootstrap.QuickSearchView=r.Bootstrap.Table.prototype.quickSearchView=r.Plain.QuickSearchView.extend({}),r.Bootstrap.InfoView=r.Bootstrap.Table.prototype.infoView=r.Plain.InfoView.extend({}),r.Bootstrap.PaginationView=r.Bootstrap.Table.prototype.paginationView=r.Plain.PaginationView.extend({}),r}(Backbone,_,$||window.jQuery||window.Zepto||window.ender);